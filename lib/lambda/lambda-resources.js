"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.createLambdaResources = createLambdaResources;
const cdk = __importStar(require("aws-cdk-lib"));
const lambda = __importStar(require("aws-cdk-lib/aws-lambda"));
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const path = __importStar(require("path"));
const fs = __importStar(require("fs"));
function createLambdaResources(scope, props) {
    const { stage, userPool, userPoolClient, existingUserPoolClientSecret, sharedDynamoDBTables, sharedS3Buckets, emailProcessQueue, importExistingResources = false } = props;
    const getResourceName = (name) => {
        return name;
    };
    const detectRuntime = (lambdaDir) => {
        const lambdaPath = path.join(__dirname, `../../lambdas/${lambdaDir}`);
        const files = fs.readdirSync(lambdaPath);
        const hasPythonFiles = files.some(file => file.endsWith('.py') || file === 'requirements.txt' || file === 'Pipfile');
        const hasNodeFiles = files.some(file => file.endsWith('.js') || file.endsWith('.mjs') || file === 'package.json');
        if (hasPythonFiles) {
            return lambda.Runtime.PYTHON_3_11;
        }
        else if (hasNodeFiles) {
            return lambda.Runtime.NODEJS_18_X;
        }
        else {
            return lambda.Runtime.NODEJS_18_X;
        }
    };
    const getHandler = (lambdaDir, runtime) => {
        const lambdaPath = path.join(__dirname, `../../lambdas/${lambdaDir}`);
        const files = fs.readdirSync(lambdaPath);
        if (runtime === lambda.Runtime.PYTHON_3_11) {
            if (files.includes('lambda_function.py')) {
                return 'lambda_function.handler';
            }
            else if (files.includes('index.py')) {
                return 'index.handler';
            }
            else {
                const pyFile = files.find(file => file.endsWith('.py'));
                if (pyFile) {
                    return `${pyFile.replace('.py', '')}.handler`;
                }
            }
        }
        else {
            if (files.includes('index.js')) {
                return 'index.handler';
            }
            else if (files.includes('index.mjs')) {
                return 'index.handler';
            }
            else {
                const jsFile = files.find(file => file.endsWith('.js') || file.endsWith('.mjs'));
                if (jsFile) {
                    return `${jsFile.replace('.js', '').replace('.mjs', '')}.handler`;
                }
            }
        }
        return runtime === lambda.Runtime.PYTHON_3_11 ? 'lambda_function.handler' : 'index.handler';
    };
    const lambdaDirs = fs.readdirSync(path.join(__dirname, '../../lambdas')).filter(dir => fs.statSync(path.join(__dirname, '../../lambdas', dir)).isDirectory());
    const lambdaFunctions = {};
    lambdaDirs.forEach((dirName) => {
        const runtime = detectRuntime(dirName);
        const handler = getHandler(dirName, runtime);
        console.log(`   Creating Lambda: ${dirName} | Runtime: ${runtime.name} | Handler: ${handler}`);
        const fn = new lambda.Function(scope, `${dirName}`, {
            functionName: getResourceName(dirName),
            runtime: runtime,
            handler: handler,
            code: lambda.Code.fromAsset(path.join(__dirname, `../../lambdas/${dirName}`)),
            memorySize: 256,
            timeout: cdk.Duration.minutes(1),
        });
        fn.role?.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName("AdministratorAccess"));
        userPool.grant(fn, 'cognito-idp:AdminCreateUser');
        userPool.grant(fn, 'cognito-idp:AdminDeleteUser');
        userPool.grant(fn, 'cognito-idp:AdminGetUser');
        userPool.grant(fn, 'cognito-idp:AdminSetUserPassword');
        userPool.grant(fn, 'cognito-idp:ListUsers');
        userPool.grant(fn, 'cognito-idp:InitiateAuth');
        lambdaFunctions[dirName] = fn;
    });
    const sharedEnv = {
        AUTH_BP: "xkirxcJV3gCa38",
        BUCKET_NAME: "xkirxcJV3gCa38",
        DB_SELECT_LAMBDA: getResourceName("DBSelect"),
        GENERATE_EV_LAMBDA_ARN: getResourceName("GenerateEV"),
        PROCESSING_LAMBDA_ARN: getResourceName("Send-Email"),
        QUEUE_URL: emailProcessQueue.queueUrl,
        SCHEDULER_ROLE_ARN: "arn:aws:iam::872515253712:role/SQS-SES-Handler",
        TAI_KEY: "2e1a1e910693ae18c09ad0585a7645e0f4595e90ec35bb366b6f5520221b6ca7",
        BEDROCK_MODEL_ARN: "arn:aws:bedrock:us-west-2::model/amazon.nova-premier-v1:0",
        COGNITO_USER_POOL_ID: userPool.userPoolId,
        COGNITO_CLIENT_ID: userPoolClient.userPoolClientId,
        COGNITO_CLIENT_SECRET: existingUserPoolClientSecret || userPoolClient.userPoolClientSecret?.unsafeUnwrap() || '',
        RATE_LIMIT_AI: "100",
        RATE_LIMIT_AWS: "1000",
        RECAPTCHA_SECRET_KEY: "6LcdgD8rAAAAAMBJ_aCebuY5e_F-IfZjL-oAs9lo",
        STAGE: stage,
        ALLOW_CORS_FUNCTION_NAME: getResourceName("Allow-Cors"),
        API_AUTHORIZER_FUNCTION_NAME: getResourceName("API-Authorizer"),
        AUTHORIZE_FUNCTION_NAME: getResourceName("Authorize"),
        CHECK_DOMAIN_STATUS_FUNCTION_NAME: getResourceName("Check-Domain-Status"),
        CREATE_SES_DKIM_RECORDS_FUNCTION_NAME: getResourceName("Create-SES-Dkim-Records"),
        CREATE_SES_IDENTITY_FUNCTION_NAME: getResourceName("Create-SES-Identity"),
        CREATE_NEW_SESSION_FUNCTION_NAME: getResourceName("CreateNewSession"),
        DB_BATCH_SELECT_FUNCTION_NAME: getResourceName("DBBatchSelect"),
        DB_DELETE_FUNCTION_NAME: getResourceName("DBDelete"),
        DB_SELECT_FUNCTION_NAME: getResourceName("DBSelect"),
        DB_UPDATE_FUNCTION_NAME: getResourceName("DBUpdate"),
        DELETE_USER_SUPABASE_FUNCTION_NAME: getResourceName("DeleteUserSupabase"),
        GENERATE_EMAIL_FUNCTION_NAME: getResourceName("GenerateEmail"),
        GET_CORS_FUNCTION_NAME: getResourceName("Get-Cors"),
        GET_THREAD_ATTRS_FUNCTION_NAME: getResourceName("getThreadAttrs"),
        GET_USER_CONVERSATIONS_FUNCTION_NAME: getResourceName("GetUserConversations"),
        LCP_LLM_RESPONSE_FUNCTION_NAME: getResourceName("LCPLlmResponse"),
        LOGIN_USER_FUNCTION_NAME: getResourceName("LoginUser"),
        ORGANIZATIONS_CRUD_FUNCTION_NAME: getResourceName("Organizations-Crud"),
        ORGANIZATIONS_INVITES_FUNCTION_NAME: getResourceName("Organizations-Invites"),
        ORGANIZATIONS_MEMBERS_FUNCTION_NAME: getResourceName("Organizations-Members"),
        PARSE_EVENT_FUNCTION_NAME: getResourceName("ParseEvent"),
        PROCESS_SQS_QUEUED_EMAILS_FUNCTION_NAME: getResourceName("Process-SQS-Queued-Emails"),
        PROCESS_NEW_USER_SUPABASE_FUNCTION_NAME: getResourceName("ProcessNewUserSupabase"),
        RATE_LIMIT_AI_FUNCTION_NAME: getResourceName("RateLimitAI"),
        RATE_LIMIT_AWS_FUNCTION_NAME: getResourceName("RateLimitAWS"),
        RETRIEVE_THREAD_INFORMATION_FUNCTION_NAME: getResourceName("Retrieve-Thread-Information"),
        SEND_EMAIL_FUNCTION_NAME: getResourceName("Send-Email"),
        TEST_SCHEDULER_FUNCTION_NAME: getResourceName("Test-Scheduler"),
        VERIFY_NEW_DOMAIN_VALID_FUNCTION_NAME: getResourceName("verifyNewDomainValid"),
    };
    Object.values(lambdaFunctions).forEach(fn => {
        fn.addEnvironment('STAGE', stage);
        Object.entries(sharedEnv).forEach(([key, value]) => {
            fn.addEnvironment(key, value);
        });
        fn.addEnvironment('CDK_AWS_REGION', scope.region);
        fn.addEnvironment('AWS_ACCOUNT_ID', scope.account);
    });
    const tables = Object.values(sharedDynamoDBTables);
    Object.values(lambdaFunctions).forEach(fn => {
        tables.forEach(table => {
            table.grantReadWriteData(fn);
        });
    });
    Object.values(lambdaFunctions).forEach(fn => {
        emailProcessQueue.grantConsumeMessages(fn);
        emailProcessQueue.grantSendMessages(fn);
    });
    Object.values(lambdaFunctions).forEach(fn => {
        Object.values(sharedS3Buckets).forEach(bucket => {
            bucket.grantReadWrite(fn);
        });
    });
    return {
        lambdaFunctions,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFtYmRhLXJlc291cmNlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxhbWJkYS1yZXNvdXJjZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXFCQSxzREErS0M7QUFwTUQsaURBQW1DO0FBQ25DLCtEQUFpRDtBQUNqRCx5REFBMkM7QUFDM0MsMkNBQTZCO0FBQzdCLHVDQUF5QjtBQWlCekIsU0FBZ0IscUJBQXFCLENBQUMsS0FBZ0IsRUFBRSxLQUEyQjtJQUNqRixNQUFNLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxjQUFjLEVBQUUsNEJBQTRCLEVBQUUsb0JBQW9CLEVBQUUsZUFBZSxFQUFFLGlCQUFpQixFQUFFLHVCQUF1QixHQUFHLEtBQUssRUFBRSxHQUFHLEtBQUssQ0FBQztJQUUzSyxNQUFNLGVBQWUsR0FBRyxDQUFDLElBQVksRUFBRSxFQUFFO1FBQ3ZDLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQyxDQUFDO0lBRUYsTUFBTSxhQUFhLEdBQUcsQ0FBQyxTQUFpQixFQUFrQixFQUFFO1FBQzFELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLGlCQUFpQixTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBQ3RFLE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFekMsTUFBTSxjQUFjLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUN2QyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksS0FBSyxrQkFBa0IsSUFBSSxJQUFJLEtBQUssU0FBUyxDQUMxRSxDQUFDO1FBRUYsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUNyQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksQ0FBQyxRQUFRLENB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QUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFO1FBQzFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQzlDLE1BQU0sQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILE9BQU87UUFDTCxlQUFlO0tBQ2hCLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gJ2F3cy1jZGstbGliJztcclxuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xyXG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XHJcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcclxuaW1wb3J0ICogYXMgY29nbml0byBmcm9tICdhd3MtY2RrLWxpYi9hd3MtY29nbml0byc7XHJcbmltcG9ydCAqIGFzIGR5bmFtb2RiIGZyb20gJ2F3cy1jZGstbGliL2F3cy1keW5hbW9kYic7XHJcbmltcG9ydCAqIGFzIHMzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMyc7XHJcbmltcG9ydCAqIGFzIHNxcyBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtc3FzJztcclxuXHJcbmludGVyZmFjZSBMYW1iZGFSZXNvdXJjZXNQcm9wcyB7XHJcbiAgc3RhZ2U6IHN0cmluZztcclxuICB1c2VyUG9vbDogY29nbml0by5JVXNlclBvb2w7XHJcbiAgdXNlclBvb2xDbGllbnQ6IGNvZ25pdG8uSVVzZXJQb29sQ2xpZW50O1xyXG4gIGV4aXN0aW5nVXNlclBvb2xDbGllbnRTZWNyZXQ/OiBzdHJpbmc7XHJcbiAgc2hhcmVkRHluYW1vREJUYWJsZXM6IHsgW2tleTogc3RyaW5nXTogZHluYW1vZGIuSVRhYmxlIH07XHJcbiAgc2hhcmVkUzNCdWNrZXRzOiB7IFtrZXk6IHN0cmluZ106IHMzLklCdWNrZXQgfTtcclxuICBlbWFpbFByb2Nlc3NRdWV1ZTogc3FzLklRdWV1ZTtcclxuICBpbXBvcnRFeGlzdGluZ1Jlc291cmNlcz86IGJvb2xlYW47XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVMYW1iZGFSZXNvdXJjZXMoc2NvcGU6IGNkay5TdGFjaywgcHJvcHM6IExhbWJkYVJlc291cmNlc1Byb3BzKSB7XHJcbiAgY29uc3QgeyBzdGFnZSwgdXNlclBvb2wsIHVzZXJQb29sQ2xpZW50LCBleGlzdGluZ1VzZXJQb29sQ2xpZW50U2VjcmV0LCBzaGFyZWREeW5hbW9EQlRhYmxlcywgc2hhcmVkUzNCdWNrZXRzLCBlbWFpbFByb2Nlc3NRdWV1ZSwgaW1wb3J0RXhpc3RpbmdSZXNvdXJjZXMgPSBmYWxzZSB9ID0gcHJvcHM7XHJcblxyXG4gIGNvbnN0IGdldFJlc291cmNlTmFtZSA9IChuYW1lOiBzdHJpbmcpID0+IHtcclxuICAgIHJldHVybiBuYW1lO1xyXG4gIH07XHJcblxyXG4gIGNvbnN0IGRldGVjdFJ1bnRpbWUgPSAobGFtYmRhRGlyOiBzdHJpbmcpOiBsYW1iZGEuUnVudGltZSA9PiB7XHJcbiAgICBjb25zdCBsYW1iZGFQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgYC4uLy4uL2xhbWJkYXMvJHtsYW1iZGFEaXJ9YCk7XHJcbiAgICBjb25zdCBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKGxhbWJkYVBhdGgpO1xyXG4gICAgXHJcbiAgICBjb25zdCBoYXNQeXRob25GaWxlcyA9IGZpbGVzLnNvbWUoZmlsZSA9PiBcclxuICAgICAgZmlsZS5lbmRzV2l0aCgnLnB5JykgfHwgZmlsZSA9PT0gJ3JlcXVpcmVtZW50cy50eHQnIHx8IGZpbGUgPT09ICdQaXBmaWxlJ1xyXG4gICAgKTtcclxuICAgIFxyXG4gICAgY29uc3QgaGFzTm9kZUZpbGVzID0gZmlsZXMuc29tZShmaWxlID0+IFxyXG4gICAgICBmaWxlLmVuZHNXaXRoKCcuanMnKSB8fCBmaWxlLmVuZHNXaXRoKCcubWpzJykgfHwgZmlsZSA9PT0gJ3BhY2thZ2UuanNvbidcclxuICAgICk7XHJcbiAgICBcclxuICAgIGlmIChoYXNQeXRob25GaWxlcykge1xyXG4gICAgICByZXR1cm4gbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfMTE7XHJcbiAgICB9IGVsc2UgaWYgKGhhc05vZGVGaWxlcykge1xyXG4gICAgICByZXR1cm4gbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE4X1g7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE4X1g7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgY29uc3QgZ2V0SGFuZGxlciA9IChsYW1iZGFEaXI6IHN0cmluZywgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUpOiBzdHJpbmcgPT4ge1xyXG4gICAgY29uc3QgbGFtYmRhUGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsIGAuLi8uLi9sYW1iZGFzLyR7bGFtYmRhRGlyfWApO1xyXG4gICAgY29uc3QgZmlsZXMgPSBmcy5yZWFkZGlyU3luYyhsYW1iZGFQYXRoKTtcclxuICAgIFxyXG4gICAgaWYgKHJ1bnRpbWUgPT09IGxhbWJkYS5SdW50aW1lLlBZVEhPTl8zXzExKSB7XHJcbiAgICAgIGlmIChmaWxlcy5pbmNsdWRlcygnbGFtYmRhX2Z1bmN0aW9uLnB5JykpIHtcclxuICAgICAgICByZXR1cm4gJ2xhbWJkYV9mdW5jdGlvbi5oYW5kbGVyJztcclxuICAgICAgfSBlbHNlIGlmIChmaWxlcy5pbmNsdWRlcygnaW5kZXgucHknKSkge1xyXG4gICAgICAgIHJldHVybiAnaW5kZXguaGFuZGxlcic7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgcHlGaWxlID0gZmlsZXMuZmluZChmaWxlID0+IGZpbGUuZW5kc1dpdGgoJy5weScpKTtcclxuICAgICAgICBpZiAocHlGaWxlKSB7XHJcbiAgICAgICAgICByZXR1cm4gYCR7cHlGaWxlLnJlcGxhY2UoJy5weScsICcnKX0uaGFuZGxlcmA7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAoZmlsZXMuaW5jbHVkZXMoJ2luZGV4LmpzJykpIHtcclxuICAgICAgICByZXR1cm4gJ2luZGV4LmhhbmRsZXInO1xyXG4gICAgICB9IGVsc2UgaWYgKGZpbGVzLmluY2x1ZGVzKCdpbmRleC5tanMnKSkge1xyXG4gICAgICAgIHJldHVybiAnaW5kZXguaGFuZGxlcic7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QganNGaWxlID0gZmlsZXMuZmluZChmaWxlID0+IGZpbGUuZW5kc1dpdGgoJy5qcycpIHx8IGZpbGUuZW5kc1dpdGgoJy5tanMnKSk7XHJcbiAgICAgICAgaWYgKGpzRmlsZSkge1xyXG4gICAgICAgICAgcmV0dXJuIGAke2pzRmlsZS5yZXBsYWNlKCcuanMnLCAnJykucmVwbGFjZSgnLm1qcycsICcnKX0uaGFuZGxlcmA7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHJldHVybiBydW50aW1lID09PSBsYW1iZGEuUnVudGltZS5QWVRIT05fM18xMSA/ICdsYW1iZGFfZnVuY3Rpb24uaGFuZGxlcicgOiAnaW5kZXguaGFuZGxlcic7XHJcbiAgfTtcclxuXHJcbiAgY29uc3QgbGFtYmRhRGlycyA9IGZzLnJlYWRkaXJTeW5jKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9sYW1iZGFzJykpLmZpbHRlcihkaXIgPT5cclxuICAgIGZzLnN0YXRTeW5jKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9sYW1iZGFzJywgZGlyKSkuaXNEaXJlY3RvcnkoKVxyXG4gICk7XHJcblxyXG4gIGNvbnN0IGxhbWJkYUZ1bmN0aW9uczogeyBba2V5OiBzdHJpbmddOiBsYW1iZGEuRnVuY3Rpb24gfSA9IHt9O1xyXG5cclxuICBsYW1iZGFEaXJzLmZvckVhY2goKGRpck5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgY29uc3QgcnVudGltZSA9IGRldGVjdFJ1bnRpbWUoZGlyTmFtZSk7XHJcbiAgICBjb25zdCBoYW5kbGVyID0gZ2V0SGFuZGxlcihkaXJOYW1lLCBydW50aW1lKTtcclxuICAgIFxyXG4gICAgY29uc29sZS5sb2coYCAgIENyZWF0aW5nIExhbWJkYTogJHtkaXJOYW1lfSB8IFJ1bnRpbWU6ICR7cnVudGltZS5uYW1lfSB8IEhhbmRsZXI6ICR7aGFuZGxlcn1gKTtcclxuICAgIFxyXG4gICAgY29uc3QgZm4gPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHNjb3BlLCBgJHtkaXJOYW1lfWAsIHtcclxuICAgICAgZnVuY3Rpb25OYW1lOiBnZXRSZXNvdXJjZU5hbWUoZGlyTmFtZSksXHJcbiAgICAgIHJ1bnRpbWU6IHJ1bnRpbWUsXHJcbiAgICAgIGhhbmRsZXI6IGhhbmRsZXIsXHJcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCBgLi4vLi4vbGFtYmRhcy8ke2Rpck5hbWV9YCkpLFxyXG4gICAgICBtZW1vcnlTaXplOiAyNTYsXHJcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDEpLFxyXG4gICAgfSk7XHJcblxyXG4gICAgZm4ucm9sZT8uYWRkTWFuYWdlZFBvbGljeShcclxuICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwiQWRtaW5pc3RyYXRvckFjY2Vzc1wiKVxyXG4gICAgKTtcclxuXHJcbiAgICB1c2VyUG9vbC5ncmFudChmbiwgJ2NvZ25pdG8taWRwOkFkbWluQ3JlYXRlVXNlcicpO1xyXG4gICAgdXNlclBvb2wuZ3JhbnQoZm4sICdjb2duaXRvLWlkcDpBZG1pbkRlbGV0ZVVzZXInKTtcclxuICAgIHVzZXJQb29sLmdyYW50KGZuLCAnY29nbml0by1pZHA6QWRtaW5HZXRVc2VyJyk7XHJcbiAgICB1c2VyUG9vbC5ncmFudChmbiwgJ2NvZ25pdG8taWRwOkFkbWluU2V0VXNlclBhc3N3b3JkJyk7XHJcbiAgICB1c2VyUG9vbC5ncmFudChmbiwgJ2NvZ25pdG8taWRwOkxpc3RVc2VycycpO1xyXG4gICAgdXNlclBvb2wuZ3JhbnQoZm4sICdjb2duaXRvLWlkcDpJbml0aWF0ZUF1dGgnKTtcclxuXHJcbiAgICBsYW1iZGFGdW5jdGlvbnNbZGlyTmFtZV0gPSBmbjtcclxuICB9KTtcclxuXHJcbiAgY29uc3Qgc2hhcmVkRW52ID0ge1xyXG4gICAgQVVUSF9CUDogXCJ4a2lyeGNKVjNnQ2EzOFwiLFxyXG4gICAgQlVDS0VUX05BTUU6IFwieGtpcnhjSlYzZ0NhMzhcIixcclxuICAgIERCX1NFTEVDVF9MQU1CREE6IGdldFJlc291cmNlTmFtZShcIkRCU2VsZWN0XCIpLFxyXG4gICAgR0VORVJBVEVfRVZfTEFNQkRBX0FSTjogZ2V0UmVzb3VyY2VOYW1lKFwiR2VuZXJhdGVFVlwiKSxcclxuICAgIFBST0NFU1NJTkdfTEFNQkRBX0FSTjogZ2V0UmVzb3VyY2VOYW1lKFwiU2VuZC1FbWFpbFwiKSxcclxuICAgIFFVRVVFX1VSTDogZW1haWxQcm9jZXNzUXVldWUucXVldWVVcmwsXHJcbiAgICBTQ0hFRFVMRVJfUk9MRV9BUk46IFwiYXJuOmF3czppYW06Ojg3MjUxNTI1MzcxMjpyb2xlL1NRUy1TRVMtSGFuZGxlclwiLFxyXG4gICAgVEFJX0tFWTogXCIyZTFhMWU5MTA2OTNhZTE4YzA5YWQwNTg1YTc2NDVlMGY0NTk1ZTkwZWMzNWJiMzY2YjZmNTUyMDIyMWI2Y2E3XCIsXHJcbiAgICBCRURST0NLX01PREVMX0FSTjogXCJhcm46YXdzOmJlZHJvY2s6dXMtd2VzdC0yOjptb2RlbC9hbWF6b24ubm92YS1wcmVtaWVyLXYxOjBcIixcclxuICAgIENPR05JVE9fVVNFUl9QT09MX0lEOiB1c2VyUG9vbC51c2VyUG9vbElkLFxyXG4gICAgQ09HTklUT19DTElFTlRfSUQ6IHVzZXJQb29sQ2xpZW50LnVzZXJQb29sQ2xpZW50SWQsXHJcbiAgICBDT0dOSVRPX0NMSUVOVF9TRUNSRVQ6IGV4aXN0aW5nVXNlclBvb2xDbGllbnRTZWNyZXQgfHwgdXNlclBvb2xDbGllbnQudXNlclBvb2xDbGllbnRTZWNyZXQ/LnVuc2FmZVVud3JhcCgpIHx8ICcnLFxyXG4gICAgUkFURV9MSU1JVF9BSTogXCIxMDBcIixcclxuICAgIFJBVEVfTElNSVRfQVdTOiBcIjEwMDBcIixcclxuICAgIFJFQ0FQVENIQV9TRUNSRVRfS0VZOiBcIjZMY2RnRDhyQUFBQUFNQkpfYUNlYnVZNWVfRi1JZlpqTC1vQXM5bG9cIixcclxuICAgIFNUQUdFOiBzdGFnZSxcclxuICAgIEFMTE9XX0NPUlNfRlVOQ1RJT05fTkFNRTogZ2V0UmVzb3VyY2VOYW1lKFwiQWxsb3ctQ29yc1wiKSxcclxuICAgIEFQSV9BVVRIT1JJWkVSX0ZVTkNUSU9OX05BTUU6IGdldFJlc291cmNlTmFtZShcIkFQSS1BdXRob3JpemVyXCIpLFxyXG4gICAgQVVUSE9SSVpFX0ZVTkNUSU9OX05BTUU6IGdldFJlc291cmNlTmFtZShcIkF1dGhvcml6ZVwiKSxcclxuICAgIENIRUNLX0RPTUFJTl9TVEFUVVNfRlVOQ1RJT05fTkFNRTogZ2V0UmVzb3VyY2VOYW1lKFwiQ2hlY2stRG9tYWluLVN0YXR1c1wiKSxcclxuICAgIENSRUFURV9TRVNfREtJTV9SRUNPUkRTX0ZVTkNUSU9OX05BTUU6IGdldFJlc291cmNlTmFtZShcIkNyZWF0ZS1TRVMtRGtpbS1SZWNvcmRzXCIpLFxyXG4gICAgQ1JFQVRFX1NFU19JREVOVElUWV9GVU5DVElPTl9OQU1FOiBnZXRSZXNvdXJjZU5hbWUoXCJDcmVhdGUtU0VTLUlkZW50aXR5XCIpLFxyXG4gICAgQ1JFQVRFX05FV19TRVNTSU9OX0ZVTkNUSU9OX05BTUU6IGdldFJlc291cmNlTmFtZShcIkNyZWF0ZU5ld1Nlc3Npb25cIiksXHJcbiAgICBEQl9CQVRDSF9TRUxFQ1RfRlVOQ1RJT05fTkFNRTogZ2V0UmVzb3VyY2VOYW1lKFwiREJCYXRjaFNlbGVjdFwiKSxcclxuICAgIERCX0RFTEVURV9GVU5DVElPTl9OQU1FOiBnZXRSZXNvdXJjZU5hbWUoXCJEQkRlbGV0ZVwiKSxcclxuICAgIERCX1NFTEVDVF9GVU5DVElPTl9OQU1FOiBnZXRSZXNvdXJjZU5hbWUoXCJEQlNlbGVjdFwiKSxcclxuICAgIERCX1VQREFURV9GVU5DVElPTl9OQU1FOiBnZXRSZXNvdXJjZU5hbWUoXCJEQlVwZGF0ZVwiKSxcclxuICAgIERFTEVURV9VU0VSX1NVUEFCQVNFX0ZVTkNUSU9OX05BTUU6IGdldFJlc291cmNlTmFtZShcIkRlbGV0ZVVzZXJTdXBhYmFzZVwiKSxcclxuICAgIEdFTkVSQVRFX0VNQUlMX0ZVTkNUSU9OX05BTUU6IGdldFJlc291cmNlTmFtZShcIkdlbmVyYXRlRW1haWxcIiksXHJcbiAgICBHRVRfQ09SU19GVU5DVElPTl9OQU1FOiBnZXRSZXNvdXJjZU5hbWUoXCJHZXQtQ29yc1wiKSxcclxuICAgIEdFVF9USFJFQURfQVRUUlNfRlVOQ1RJT05fTkFNRTogZ2V0UmVzb3VyY2VOYW1lKFwiZ2V0VGhyZWFkQXR0cnNcIiksXHJcbiAgICBHRVRfVVNFUl9DT05WRVJTQVRJT05TX0ZVTkNUSU9OX05BTUU6IGdldFJlc291cmNlTmFtZShcIkdldFVzZXJDb252ZXJzYXRpb25zXCIpLFxyXG4gICAgTENQX0xMTV9SRVNQT05TRV9GVU5DVElPTl9OQU1FOiBnZXRSZXNvdXJjZU5hbWUoXCJMQ1BMbG1SZXNwb25zZVwiKSxcclxuICAgIExPR0lOX1VTRVJfRlVOQ1RJT05fTkFNRTogZ2V0UmVzb3VyY2VOYW1lKFwiTG9naW5Vc2VyXCIpLFxyXG4gICAgT1JHQU5JWkFUSU9OU19DUlVEX0ZVTkNUSU9OX05BTUU6IGdldFJlc291cmNlTmFtZShcIk9yZ2FuaXphdGlvbnMtQ3J1ZFwiKSxcclxuICAgIE9SR0FOSVpBVElPTlNfSU5WSVRFU19GVU5DVElPTl9OQU1FOiBnZXRSZXNvdXJjZU5hbWUoXCJPcmdhbml6YXRpb25zLUludml0ZXNcIiksXHJcbiAgICBPUkdBTklaQVRJT05TX01FTUJFUlNfRlVOQ1RJT05fTkFNRTogZ2V0UmVzb3VyY2VOYW1lKFwiT3JnYW5pemF0aW9ucy1NZW1iZXJzXCIpLFxyXG4gICAgUEFSU0VfRVZFTlRfRlVOQ1RJT05fTkFNRTogZ2V0UmVzb3VyY2VOYW1lKFwiUGFyc2VFdmVudFwiKSxcclxuICAgIFBST0NFU1NfU1FTX1FVRVVFRF9FTUFJTFNfRlVOQ1RJT05fTkFNRTogZ2V0UmVzb3VyY2VOYW1lKFwiUHJvY2Vzcy1TUVMtUXVldWVkLUVtYWlsc1wiKSxcclxuICAgIFBST0NFU1NfTkVXX1VTRVJfU1VQQUJBU0VfRlVOQ1RJT05fTkFNRTogZ2V0UmVzb3VyY2VOYW1lKFwiUHJvY2Vzc05ld1VzZXJTdXBhYmFzZVwiKSxcclxuICAgIFJBVEVfTElNSVRfQUlfRlVOQ1RJT05fTkFNRTogZ2V0UmVzb3VyY2VOYW1lKFwiUmF0ZUxpbWl0QUlcIiksXHJcbiAgICBSQVRFX0xJTUlUX0FXU19GVU5DVElPTl9OQU1FOiBnZXRSZXNvdXJjZU5hbWUoXCJSYXRlTGltaXRBV1NcIiksXHJcbiAgICBSRVRSSUVWRV9USFJFQURfSU5GT1JNQVRJT05fRlVOQ1RJT05fTkFNRTogZ2V0UmVzb3VyY2VOYW1lKFwiUmV0cmlldmUtVGhyZWFkLUluZm9ybWF0aW9uXCIpLFxyXG4gICAgU0VORF9FTUFJTF9GVU5DVElPTl9OQU1FOiBnZXRSZXNvdXJjZU5hbWUoXCJTZW5kLUVtYWlsXCIpLFxyXG4gICAgVEVTVF9TQ0hFRFVMRVJfRlVOQ1RJT05fTkFNRTogZ2V0UmVzb3VyY2VOYW1lKFwiVGVzdC1TY2hlZHVsZXJcIiksXHJcbiAgICBWRVJJRllfTkVXX0RPTUFJTl9WQUxJRF9GVU5DVElPTl9OQU1FOiBnZXRSZXNvdXJjZU5hbWUoXCJ2ZXJpZnlOZXdEb21haW5WYWxpZFwiKSxcclxuICB9O1xyXG5cclxuICBPYmplY3QudmFsdWVzKGxhbWJkYUZ1bmN0aW9ucykuZm9yRWFjaChmbiA9PiB7XHJcbiAgICBmbi5hZGRFbnZpcm9ubWVudCgnU1RBR0UnLCBzdGFnZSk7XHJcbiAgICBPYmplY3QuZW50cmllcyhzaGFyZWRFbnYpLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xyXG4gICAgICBmbi5hZGRFbnZpcm9ubWVudChrZXksIHZhbHVlKTtcclxuICAgIH0pO1xyXG4gICAgXHJcbiAgICBmbi5hZGRFbnZpcm9ubWVudCgnQ0RLX0FXU19SRUdJT04nLCBzY29wZS5yZWdpb24pO1xyXG4gICAgZm4uYWRkRW52aXJvbm1lbnQoJ0FXU19BQ0NPVU5UX0lEJywgc2NvcGUuYWNjb3VudCk7XHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IHRhYmxlcyA9IE9iamVjdC52YWx1ZXMoc2hhcmVkRHluYW1vREJUYWJsZXMpO1xyXG5cclxuICBPYmplY3QudmFsdWVzKGxhbWJkYUZ1bmN0aW9ucykuZm9yRWFjaChmbiA9PiB7XHJcbiAgICB0YWJsZXMuZm9yRWFjaCh0YWJsZSA9PiB7XHJcbiAgICAgIHRhYmxlLmdyYW50UmVhZFdyaXRlRGF0YShmbik7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgT2JqZWN0LnZhbHVlcyhsYW1iZGFGdW5jdGlvbnMpLmZvckVhY2goZm4gPT4ge1xyXG4gICAgZW1haWxQcm9jZXNzUXVldWUuZ3JhbnRDb25zdW1lTWVzc2FnZXMoZm4pO1xyXG4gICAgZW1haWxQcm9jZXNzUXVldWUuZ3JhbnRTZW5kTWVzc2FnZXMoZm4pO1xyXG4gIH0pO1xyXG5cclxuICBPYmplY3QudmFsdWVzKGxhbWJkYUZ1bmN0aW9ucykuZm9yRWFjaChmbiA9PiB7XHJcbiAgICBPYmplY3QudmFsdWVzKHNoYXJlZFMzQnVja2V0cykuZm9yRWFjaChidWNrZXQgPT4ge1xyXG4gICAgICBidWNrZXQuZ3JhbnRSZWFkV3JpdGUoZm4pO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBsYW1iZGFGdW5jdGlvbnMsXHJcbiAgfTtcclxufSAiXX0=